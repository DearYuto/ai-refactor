datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String          @id @default(cuid())
  email        String          @unique
  passwordHash String
  createdAt    DateTime        @default(now())
  orders       Order[]
  balances     WalletBalance[]
  transactions Transaction[]
  deposits     Deposit[]
  withdrawals  Withdrawal[]
}

model Order {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  side        String
  type        String   @default("market")
  size        Float
  price       Float?
  filledPrice Float?
  notional    Float?
  source      String
  baseAsset   String
  quoteAsset  String
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  buyTrades   Trade[]  @relation("BuyOrder")
  sellTrades  Trade[]  @relation("SellOrder")

  @@index([userId, status])
  @@index([source, status, side])
}

model WalletBalance {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  asset     String
  available Float    @default(0)
  locked    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, asset])
}

model Trade {
  id          String   @id @default(cuid())
  buyOrderId  String
  buyOrder    Order    @relation("BuyOrder", fields: [buyOrderId], references: [id])
  sellOrderId String
  sellOrder   Order    @relation("SellOrder", fields: [sellOrderId], references: [id])
  price       Float
  size        Float
  buyerFee    Float
  sellerFee   Float
  source      String
  timestamp   DateTime @default(now())

  @@index([source, timestamp])
}

model Fee {
  id        String   @id @default(cuid())
  asset     String   @unique
  makerFee  Float    @default(0.001)
  takerFee  Float    @default(0.002)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  type          String   // DEPOSIT, WITHDRAW, TRADE_BUY, TRADE_SELL, FEE, LOCK, UNLOCK
  amount        Float
  asset         String
  balanceBefore Float
  balanceAfter  Float
  relatedId     String?  // Order ID or Trade ID
  timestamp     DateTime @default(now())

  @@index([userId, timestamp])
  @@index([userId, asset, timestamp])
}

model Deposit {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  asset         String   // BTC, USDT, KRW
  amount        Float
  txHash        String?  // 블록체인 트랜잭션 해시 (실제 입금 시)
  status        String   @default("pending") // pending, confirmed, failed
  confirmations Int      @default(0) // 블록체인 확인 횟수
  createdAt     DateTime @default(now())
  confirmedAt   DateTime?

  @@index([userId, status])
  @@index([status, createdAt])
}

model Withdrawal {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  asset         String   // BTC, USDT, KRW
  amount        Float
  fee           Float    // 출금 수수료
  toAddress     String   // 출금 주소
  txHash        String?  // 블록체인 트랜잭션 해시 (실제 출금 시)
  status        String   @default("pending") // pending, approved, processing, completed, rejected
  rejectReason  String?
  requestedAt   DateTime @default(now())
  approvedAt    DateTime?
  completedAt   DateTime?

  @@index([userId, status])
  @@index([status, requestedAt])
}
